### MySQL主备的基本原理
##### 主备切换
当主服务器宕机或者出现一些其他问题时，需要进行主备切换。

一般建议将备库设置为readonly，原因如下：
1. 有时运营类的查询语句会放到备库上查，设置为只读可以防止误操作。
2. 切换时的bug，可能会出现“双写”，导致主备不一致。
3. 可用readonly来判断主备身份。

###### 超级权限用户
只有超级权限的线程可以对备库进行更新同步。

##### 主备同步流程
![](主备流程图.png)
主库A中的dump_thread和备库B中的io_thread用于维护主备之间的长连接。
1. 备库B通过change master命令，设置主机A的IP地址、端口、用户名、密码，以及要从主库A中的哪个位置开始请求binlog，这个位置包括文件名和日志偏移量。
2. 备库B上执行start slave命令，此时备库会启动2个线程：sql_thread和io_thread.
3. 主库A校验完用户名和密码后，就根据备库B发过来的位置，从本地读取binlog发给备库B。
4. 备库B的io_thread接收到主库A传来的binlog，存放在relay log(中转日志)中。
5. sql_thread读取中转日志中的指令，解析并执行。

### binlog的三种格式
#### statement
记录的是主库A中执行的sql语句原文，包括注释。有可能出现主备不一致的情况，比如使用多个索引查找并删除某一行记录时，两个库选中的可能是满足条件的不同记录。

#### row
记录的是数据库中每行发生的变化，比如具体到删除的那行的主键是多少，极大降低了主备不一致的风险，但是占用的空间会比较庞大，写binlog也会耗费很多IO资源，影响执行速度。

#### mixed
statement与row的混合模式。MySQL自己判断当前执行的语句是否有可能引起主备不一致，如果是，就使用row格式，否则就使用statement格式。
