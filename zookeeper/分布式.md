## cap要了什么
zookeeper要了c和p
在重新选举阶段集群会处于不可用的状态

## zookeeper不同角色
zk会有三种不同角色
leader，follower和observer
leader主要负责写
follower和observer主要负责读
但是observer不会参与选主

## zookeeper节点状态
一个节点有可能有以下几种状态
LOOKING，正在选主的时候会有这种状态，当前集群不存在Leader。该状态下会发起领导者选举。
FOLLOWING，随从状态，同步Leader状态，参与投票。
OBSERVING，观察状态，同步Leader状态，不参与投票。
LEADING，领导者状态，对应Leader角色。

## 集群状态
ELECTION，选举状态，表明节点正在进行Leader选举
DISCOVERY，成员发现状态，在选举出新Leader后集群所处的状态，用于节点协商沟通Leader的合法性
SYNCHRONIZATION，数据同步状态，在确认新Leader后，以Leader的数据为基础，修复各个节点的数据一致性
BROADCARST，广播状态，集群处于正常运行状态，可向外提供服务

## 一致性协议zab
zxid前32位用于标识当前leader的epoch，只以epoch最大的proposal才会处理，可以解决脑裂的问题。
后面位数只作为计数器使用，可以保证事务的顺序


## 崩溃恢复
1.过半的follower ack过的事务，已经广播commit了，会保证最终commit
2.广播pre了，还没广播commit的，会保证丢弃

## 选主过程
采用投票制，首先每个follower投自己，然后进行广播
收到广播后，和自己的投票进行pk
1.比较epoch，也就是zxid的高位，32位，大的当选
2.epoch一样，比较zxid的大小，其实就是比较计数器了，大的当选
3.都一样，那么比较myid，这个是配置项配好的。
选举完毕之后，集群变成了discover的状态

## 同步过程（逻辑时钟）
选举完毕，还需要同步epoch
所有的follower会主动将自己的最新的消息发给leader，带有epoch
leader选出其中epoch最大的，加一，就可以当成是一个新的epoch了
最后再同步回所有的follower
同步完毕，集群进入了synchronization的状态

## 与paxos不同
paxos允许多个提议者
zookeeper只允许leader提议，从而保证最终状态的顺序性
